<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥¥å³»ä¸­é†« - è‹±æ–‡è™•æ–¹ç±¤ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }

        /* è¢å¹•é¡¯ç¤ºå€å¡Šæ¨£å¼ */
        .screen-only {
            display: block;
        }

        /* A4 åˆ—å°å€å¡Šæ¨£å¼ - é è¨­åœ¨è¢å¹•ä¸Šç¸®å°é¡¯ç¤ºä»¥ä¾¿é è¦½ */
        #printable-area {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 15mm 20mm;
            margin: 20px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .rx-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        .rx-table th {
            border-bottom: 2px solid #000;
            text-align: left;
            padding: 5px;
            font-weight: bold;
        }
        .rx-table td {
            border-bottom: 1px solid #ddd;
            padding: 6px 5px;
            vertical-align: top;
        }
        .rx-table tr:last-child td {
            border-bottom: 2px solid #000;
        }

        /* éš±è—å…ƒç´  */
        .hidden { display: none; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ --- */
        @media print {
            @page {
                size: A4;
                margin: 0; /* ç€è¦½å™¨é‚Šè·è¨­ç‚º0ï¼Œç”±CSSæ§åˆ¶å…§è· */
            }
            body {
                background-color: white;
                margin: 0;
            }
            .screen-only {
                display: none !important; /* éš±è—æ“ä½œé¢æ¿ */
            }
            #printable-area {
                width: 100%;
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="p-4">

    <div class="screen-only max-w-6xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-blue-800">1. ä¸Šå‚³èˆ‡è³‡æ–™è¼¸å…¥</h2>
            
            <div class="mb-4 p-4 border-2 border-dashed border-gray-300 rounded bg-gray-50 text-center">
                <label class="block mb-2 font-bold text-gray-700">æ‹ç…§æˆ–ä¸Šå‚³è™•æ–¹ç±¤ (è¼”åŠ©è¾¨è­˜)</label>
                <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <div id="ocr-status" class="text-sm text-orange-600 mt-2 hidden">æ­£åœ¨è¾¨è­˜è—¥å“ä¸­ (è«‹ç¨å€™)...</div>
                <img id="preview-img" class="mt-4 max-h-48 mx-auto hidden border" />
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-bold">æ‚£è€…å§“å (Patient Name)</label>
                    <input type="text" id="input-name" class="w-full border p-2 rounded" placeholder="Ex: LIN, CHIH-HSUN">
                </div>
                <div>
                    <label class="block text-sm font-bold">æ€§åˆ¥ (Gender)</label>
                    <select id="input-sex" class="w-full border p-2 rounded">
                        <option value="Male">Male (ç”·)</option>
                        <option value="Female">Female (å¥³)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold">å‡ºç”Ÿå¹´ (Birth Year)</label>
                    <input type="text" id="input-dob" class="w-full border p-2 rounded" placeholder="YYYY/MM/DD">
                </div>
                <div>
                    <label class="block text-sm font-bold">è¨ºæ–·ä»£ç¢¼ (Diagnosis)</label>
                    <input type="text" id="input-diag" class="w-full border p-2 rounded" value="Cough (R059)">
                </div>
            </div>

            <hr class="my-4">

            <div class="mb-4">
                <label class="block text-sm font-bold mb-1">å¿«é€Ÿæ–°å¢è—¥å“ (è¼¸å…¥ä¸­æ–‡é—œéµå­—)</label>
                <div class="flex gap-2">
                    <input type="text" id="drug-search" list="drug-list" class="flex-1 border p-2 rounded" placeholder="ä¾‹å¦‚: è‘›æ ¹, ç”Ÿè„ˆ...">
                    <datalist id="drug-list">
                        </datalist>
                    <button onclick="addDrugFromInput()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">æ–°å¢</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">* è‹¥ OCR è¾¨è­˜ä¸å…¨ï¼Œè«‹åœ¨æ­¤æ‰‹å‹•è£œä¸Š</p>
            </div>

            <button onclick="window.print()" class="w-full bg-blue-800 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-900 transition text-lg">
                ğŸ–¨ï¸ åˆ—å°è‹±æ–‡è™•æ–¹ç±¤ (Print A4)
            </button>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg overflow-y-auto" style="max-height: 80vh;">
            <h2 class="text-xl font-bold mb-4 text-blue-800">2. è—¥å“æ¸…å–®ç¢ºèª</h2>
            <div id="medicine-list-editor" class="space-y-2">
                <p class="text-gray-400 text-center py-4">ç›®å‰ç„¡è—¥å“ï¼Œè«‹ä¸Šå‚³ç…§ç‰‡æˆ–æ‰‹å‹•æ–°å¢</p>
            </div>
        </div>
    </div>

    <div id="printable-area">
        <div class="text-center border-b-2 border-black pb-4 mb-4">
            <h1 class="text-2xl font-bold uppercase tracking-wide">Xiangjun Chinese Medicine Clinic</h1>
            <p class="text-sm mt-1">6F-1, No. 1, Shizheng N. 1st Rd., Xitun Dist., Taichung City 407, Taiwan</p>
            <p class="text-sm">Tel: +886-4-2473-5561 | Attending Physician: Dr. Yu-Yen Lin (æ—ä½‘å½¥ é†«å¸«)</p>
        </div>

        <h2 class="text-xl font-bold text-center mb-6 border-2 border-black py-1 inline-block px-8 mx-auto block w-max">PRESCRIPTION</h2>

        <div class="grid grid-cols-2 gap-y-2 text-sm mb-6 font-mono">
            <div><strong>Patient Name:</strong> <span id="out-name">LIN, CHIH-HSUN</span></div>
            <div><strong>Gender:</strong> <span id="out-sex">Male</span></div>
            <div><strong>Date of Birth:</strong> <span id="out-dob">2022/**/**</span></div>
            <div><strong>Date of Visit:</strong> <span id="out-date"></span></div>
            <div class="col-span-2"><strong>Diagnosis:</strong> <span id="out-diag">Cough (R059)</span></div>
        </div>

        <table class="rx-table">
            <thead>
                <tr>
                    <th style="width: 5%;">#</th>
                    <th style="width: 65%;">Medicine Name (Pin Yin / Scientific Name)</th>
                    <th style="width: 15%;">Daily</th>
                    <th style="width: 15%;">Total</th>
                </tr>
            </thead>
            <tbody id="rx-table-body">
                </tbody>
        </table>

        <div class="mt-8 text-sm grid grid-cols-2 gap-8">
            <div>
                <h3 class="font-bold border-b border-gray-400 mb-2">Instructions</h3>
                <p><strong>Total Duration:</strong> <span id="out-days">4</span> Days</p>
                <p><strong>Frequency:</strong> 3 times a day (t.i.d.)</p>
                <p><strong>Method:</strong> Take one packet after meals with warm water.</p>
                <p><strong>Packet Weight:</strong> 1.4 g per packet</p>
            </div>
            <div>
                <h3 class="font-bold border-b border-gray-400 mb-2">Validation</h3>
                <div class="mt-8 pt-4 border-t border-black">
                    <p><strong>Physician's Signature:</strong></p>
                    <p class="mt-8">Dr. Yu-Yen Lin, M.D. (TCM)</p>
                </div>
            </div>
        </div>
        
        <div class="absolute bottom-4 left-0 w-full text-center text-xs text-gray-400">
            Generated by Xiangjun Clinic System
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« (å¯è‡ªè¡Œæ“´å……) ---
        // æ ¼å¼: key ç‚ºä¸­æ–‡é—œéµå­—, value ç‚ºè‹±æ–‡ç‰©ä»¶
        const medicineDB = {
            "è‘›æ ¹æ¹¯": { name: "Ge Gen Tang (Pueraria Decoction)", type: "Formula" },
            "ç”Ÿè„ˆé£²": { name: "Sheng Mai Yin (Pulse-Generating Drink)", type: "Formula" },
            "ç”˜éº¥å¤§æ£—æ¹¯": { name: "Gan Mai Da Zao Tang (Licorice, Wheat, & Jujube)", type: "Formula" },
            "ç”˜éœ²æ¶ˆæ¯’ä¸¹": { name: "Gan Lu Xiao Du Dan (Sweet Dew Special Pill)", type: "Formula" },
            "åƒè‹“ç™½æœ®æ•£": { name: "Shen Ling Bai Zhu San (Ginseng, Poria & Atractylodes)", type: "Formula" },
            "ç™¾åˆå›ºé‡‘æ¹¯": { name: "Bai He Gu Jin Tang (Lily Bulb Decoction)", type: "Formula" },
            "çŸ¥æŸåœ°é»ƒä¸¸": { name: "Zhi Bai Di Huang Wan (Anemarrhena, Phellodendron & Rehmannia)", type: "Formula" },
            "è±¬è‹“æ¹¯": { name: "Zhu Ling Tang (Polyporus Decoction)", type: "Formula" },
            "æº«ç¶“æ¹¯": { name: "Wen Jing Tang (Menses-Warming Decoction)", type: "Formula" },
            "å·¦æ­¸ä¸¸": { name: "Zuo Gui Wan (Kidney-Yin-Tonifying Pill)", type: "Formula" },
            "é å¿—": { name: "Yuan Zhi (Polygalae Radix)", type: "Herb" },
            "çŸ³è–è’²": { name: "Shi Chang Pu (Acori Tatarinowii Rhizoma)", type: "Herb" },
            "æ‹¬æ¨“ä»": { name: "Gua Lou Ren (Trichosanthis Semen)", type: "Herb" },
            "é­šè…¥è‰": { name: "Yu Xing Cao (Houttuynia Cordata)", type: "Herb" },
            "æ¡‘ç™½çš®": { name: "Sang Bai Pi (Mori Cortex)", type: "Herb" },
            "å¤æ¯è‰": { name: "Xia Ku Cao (Prunellae Spica)", type: "Herb" },
            "å¥³è²å­": { name: "Nu Zhen Zi (Ligustri Lucidi Fructus)", type: "Herb" },
            "æœä»²": { name: "Du Zhong (Eucommiae Cortex)", type: "Herb" },
            "ç™½èŠ": { name: "Bai Shao (Paeoniae Radix Alba)", type: "Herb" },
            "ç´«è˜‡è‘‰": { name: "Zi Su Ye (Perillae Folium)", type: "Herb" },
            "ç´«è€": { name: "Zi Wan (Asteris Radix)", type: "Herb" },
            "è™æ–": { name: "Hu Zhang (Polygoni Cuspidati Rhizoma)", type: "Herb" },
            "ç”˜è‰": { name: "Gan Cao (Glycyrrhizae Radix)", type: "Herb" },
            "è›¹èŸ²è‰": { name: "Cordyceps Militaris Powder (Supplement)", type: "Supp" },
            "ç›Šç”ŸèŒ": { name: "Honey Probiotics (Supplement)", type: "Supp" }
        };

        // ç•¶å‰è™•æ–¹åˆ—è¡¨
        let currentRx = [];

        // åˆå§‹åŒ–
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            document.getElementById('out-date').innerText = today;
            
            // å¡«å…… datalist
            const datalist = document.getElementById('drug-list');
            for (let key in medicineDB) {
                let option = document.createElement('option');
                option.value = key;
                datalist.appendChild(option);
            }
        };

        // --- 2. æ ¸å¿ƒåŠŸèƒ½: æ–°å¢è—¥å“ ---
        function addDrug(chineseName, dailyDose = 0.3) {
            // ç°¡å–®æ¨¡ç³Šæ¯”å°
            let matchKey = Object.keys(medicineDB).find(k => k.includes(chineseName) || chineseName.includes(k));
            let drugInfo = matchKey ? medicineDB[matchKey] : { name: chineseName + " (Need Translation)", type: "Unknown" };
            
            // è¨ˆç®—ç¸½é‡ (é è¨­4å¤©)
            let days = 4;
            let total = (dailyDose * days).toFixed(1);

            let item = {
                id: Date.now() + Math.random(),
                name: drugInfo.name,
                chinese: matchKey || chineseName,
                daily: dailyDose,
                total: total
            };

            currentRx.push(item);
            renderRx();
        }

        function addDrugFromInput() {
            const input = document.getElementById('drug-search');
            if(input.value) {
                addDrug(input.value);
                input.value = '';
                input.focus();
            }
        }

        function removeDrug(id) {
            currentRx = currentRx.filter(item => item.id !== id);
            renderRx();
        }

        // --- 3. æ¸²æŸ“ç•«é¢ ---
        function renderRx() {
            // æ¸²æŸ“ç·¨è¼¯å€ (å³å´)
            const editor = document.getElementById('medicine-list-editor');
            // æ¸²æŸ“åˆ—å°å€ (ä¸‹æ–¹)
            const tbody = document.getElementById('rx-table-body');
            
            editor.innerHTML = '';
            tbody.innerHTML = '';

            if (currentRx.length === 0) {
                editor.innerHTML = '<p class="text-gray-400 text-center py-4">ç„¡è—¥å“è³‡æ–™</p>';
                return;
            }

            currentRx.forEach((item, index) => {
                // ç·¨è¼¯å€ UI
                const editRow = document.createElement('div');
                editRow.className = 'flex items-center justify-between bg-gray-50 p-2 rounded border';
                editRow.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-sm text-blue-900">${item.chinese}</div>
                        <div class="text-xs text-gray-600 truncate">${item.name}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" step="0.1" value="${item.daily}" 
                               class="w-16 border rounded text-center text-sm" 
                               onchange="updateDose(${item.id}, this.value)">
                        <span class="text-xs">g/æ—¥</span>
                        <button onclick="removeDrug(${item.id})" class="text-red-500 hover:text-red-700 font-bold px-2">âœ•</button>
                    </div>
                `;
                editor.appendChild(editRow);

                // åˆ—å°å€ UI
                const printRow = document.createElement('tr');
                printRow.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.daily} g</td>
                    <td>${item.total} g</td>
                `;
                tbody.appendChild(printRow);
            });
        }

        function updateDose(id, newDose) {
            let item = currentRx.find(i => i.id === id);
            if (item) {
                item.daily = parseFloat(newDose);
                item.total = (item.daily * 4).toFixed(1); // å‡è¨­4å¤©
                renderRx();
            }
        }

        // --- 4. ç›£è½è¼¸å…¥æ¬„ä½åŒæ­¥åˆ°åˆ—å°å€ ---
        ['input-name', 'input-sex', 'input-dob', 'input-diag'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const targetId = id.replace('input', 'out');
                document.getElementById(targetId).innerText = this.value;
            });
        });

        // --- 5. OCR åœ–åƒè¾¨è­˜é‚è¼¯ (Tesseract.js) ---
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // é¡¯ç¤ºé è¦½åœ–
            const img = document.getElementById('preview-img');
            img.src = URL.createObjectURL(file);
            img.classList.remove('hidden');
            
            const status = document.getElementById('ocr-status');
            status.classList.remove('hidden');
            status.innerText = "æ­£åœ¨åˆ†æåœ–ç‰‡ä¸¦å°‹æ‰¾è—¥å“é—œéµå­—... (éœ€æ•¸ç§’)";

            // åŸ·è¡Œè¾¨è­˜
            Tesseract.recognize(
                file,
                'chi_tra', // ä½¿ç”¨ç¹é«”ä¸­æ–‡æ¨¡å‹
                { logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
                console.log("OCR Result:", text);
                status.innerText = "åˆ†æå®Œæˆï¼å·²è‡ªå‹•åŠ å…¥åµæ¸¬åˆ°çš„è—¥å“ã€‚";
                
                // æ™ºæ…§åŒ¹é…ï¼šæª¢æŸ¥æ–‡å­—ä¸­æ˜¯å¦åŒ…å«è³‡æ–™åº«ä¸­çš„è—¥å
                let foundCount = 0;
                // å…ˆæ¸…é™¤èˆŠçš„ (å¯é¸)
                // currentRx = []; 
                
                Object.keys(medicineDB).forEach(key => {
                    // ç°¡å–®çš„é—œéµå­—æœå°‹ï¼Œå¿½ç•¥ç©ºç™½
                    if (text.replace(/\s/g, '').includes(key)) {
                        addDrug(key, 0.3); // é è¨­åŠ‘é‡ï¼Œä¹‹å¾Œå¯æ‰‹å‹•æ”¹
                        foundCount++;
                    }
                });

                if(foundCount === 0) {
                    status.innerText = "OCR å®Œæˆï¼Œä½†æœªåµæ¸¬åˆ°å·²çŸ¥è—¥åï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚";
                } else {
                    status.innerText = `æˆåŠŸåµæ¸¬ä¸¦åŠ å…¥ ${foundCount} é …è—¥å“ï¼è«‹æª¢æŸ¥ä¸¦ä¿®æ­£åŠ‘é‡ã€‚`;
                }
            });
        });

    </script>
</body>
</html>
